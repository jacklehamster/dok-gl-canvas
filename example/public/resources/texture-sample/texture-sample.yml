# yaml-language-server: $schema=https://jacklehamster.github.io/dok-gl-actions/schema.json

scripts:
  - reference: ../lib/init-buffer.yaml
  - name: refresh
    actions:
    - uniform:
        location: frame
        float: ~{frame}
    - clear:
        color: true
      drawArrays:
        vertexCount: 6
  - name: loadImage
    actions:
    - hooks: [hasImageId]
      actions:
      - uniform:
          location: uTexture
          int: 0
        image:
          src: ~{src}
          imageId: ~{imageId}
        callback:
          onLoad:
          - initTexture:
              textureId: 0
              width: ~{textureSize}
              height: ~{textureSize}
          - sets:
              spriteWidth: ~{width / rows}
              spriteHeight: ~{height / cols}
              slotSideCount: ~{textureSize / slotSize}
          - loop: ["~{rows}", "~{cols}"]
            loadTexture:
              textureId: 0
              imageId: ~{imageId}
              sourceRect: ["~{i * spriteWidth}", "~{j * spriteHeight}", "~{spriteWidth}", "~{spriteHeight}"]
              destRect: ["~{mod(index, slotSideCount) * slotSize}", 0, "~{slotSize}", "~{slotSize}"]
          - executeScript: redraw
      - pause: ~{hasImageId(imageId)}
      - log: "~Image loaded: {imageId}"
  - actions:
    - actions:
      - sets:
          slotSize: 256
          textureSize: 4096
    - uniform:
        location: slotTex
        float: ~{slotSize / textureSize}
    - executeScript: initBuffer
      parameters:
        location: position
        size: 3
        buffer: [
          -0.5, 0.5, 0.0,
          -0.5, -0.5, 0.0,
          0.5, -0.5, 0.0,
          -0.5, 0.5, 0.0,
          0.5, -0.5, 0.0,
          0.5, 0.5, 0.0,
        ]
    - executeScript: initBuffer
      parameters:
        location: tex
        size: 2
        buffer: [
          0, 0,
          0, 1,
          1, 1,
          0, 0,
          1, 1,
          1, 0,
        ]
    - executeScript: loadImage
      parameters:
        src: turtle.png
        imageId: turtle
        slotSize: ~{slotSize}
        textureSize: ~{textureSize}
        rows: 8
        cols: 1
    - hooks: [hasImageId]
      pause: ~{not hasImageId("turtle")}
    - executeScript: refresh
      refresh:
        frameRate: 30
    tags: [main]
programs:
  - id: sample-texture
    vertex: ~reference=vertex.glsl
    fragment: ~reference=fragment.glsl
