# yaml-language-server: $schema=https://jacklehamster.github.io/dok-gl-actions/schema.json

scripts:
  - reference: ../lib/buffer-data.yaml
  - reference: ../lib/init-buffer.yaml
  - reference: ../lib/matrix-identity.yaml
  - reference: ../lib/init-matrix.yaml
  - name: redraw
    actions:
    - clear: { color: true, depth: true }
      drawElements:
        count: ~{vertexCount}
        glType: UNSIGNED_SHORT
        instanceCount: ~{instanceCount}
  - name: refresh
    actions:
    - uniform:
        location: frame
        float: ~{frame}
    - bindBuffer:
        location: matrix
    - parameters:
        size: 2
        time: ~{time}
        rotateSpeed: ~{1/10}
        instanceCount: ~{instanceCount}
      loop: ~{instanceCount}
      spriteMatrixTransform:
        translate: [0, "~{index * 2 - 5}", "~{-15}"]
        scale: ["~{size - index * 0.2}", "~{size - index * 0.2}", 0]
        rotation: [0, "~{mod(time * rotateSpeed, 360)}", 0]
      bufferSubDataMatrix:
        index: ~{index}
    - executeScript: redraw
      parameters:
        vertexCount: ~{vertexCount}
        instanceCount: ~{instanceCount}
  - name: loadImage
    actions:
    - hooks: [hasImageId]
      actions:
      - uniform:
          location: uTexture
          int: 0
        image:
          src: ~{src}
          imageId: ~{imageId}
        callback:
          onLoad:
          - loadTexture:
              textureId: 0
              imageId: ~{imageId}
          - executeScript: redraw
            parameters:
              vertexCount: ~{vertexCount}
              instanceCount: ~{instanceCount}
      - pause: ~{hasImageId(imageId)}
      - log: "~Image loaded: {imageId}"        
  - actions:
    - sets:
        walls: 1
        vertexPerWall: 6
        instanceCount: 10
    - sets:
        vertexCount: ~{vertexPerWall * walls}
        BYTES_PER_FLOAT: 4
    - sets:
        spriteWidth: 238
        spriteSheetWidth: 1886
    - sets:
        w: ~{spriteWidth / spriteSheetWidth}
    - executeScript: initBuffer
      parameters:
        target: ARRAY_BUFFER
        location: position
        size: 3
        buffer: [
          1, 1, 0,
          1, -1, 0,
          -1, -1, 0,
          -1, 1, 0,

          # 1, 1, 1,
          # 1, -1, 1,
          # -1, -1, 1,
          # -1, 1, 1,
        ]
    - executeScript: bufferData
      parameters:
        target: ELEMENT_ARRAY_BUFFER
        glType: UNSIGNED_SHORT
        location: index
        buffer: [
          0, 1, 2,  # Face
          3, 0, 2,  # Face

          # 4, 5, 6,  # Back
          # 7, 4, 6,  # Back

          # 0, 1, 4,  # Left
          # 5, 1, 4,  # Left

          # 2, 3, 6,  # Right
          # 7, 3, 6,  # Right
        ]
    - executeScript: initBuffer
      parameters:
        location: tex
        size: 2
        buffer: [
          0, 0,
          0, 1,
          "~{w}", 1,
          "~{w}", 0,

          # "~{w}", 0,
          # "~{w}", 1,
          # 0, 1,
          # 0, 0,
        ]
    - executeScript: initMatrix
      parameters:
        location: matrix
        instanceCount: ~{instanceCount}
    - initMatrix: true
    - orthogonalProjectionMatrixTransform:
        left: -10
        right: 10
        top: -10
        bottom: 10
        zNear: 0.1
        zFar: 1000
    - uniform:
        location: orthogonal
        buffer: ~{matrix}
    - perspectiveProjectionMatrixTransform:
        viewAngle: 45
        aspect: 1
        zNear: 0.1
        zFar: 1000
    - uniform:
        location: perspective
        buffer: ~{matrix}
    - uniform:
        location: isPerspective
        float: 1
    - initMatrix: true
    - hooks:
      - gl
      actions:
      - callExternal:
          subject: ~{gl}
          method: enable
          arguments: {subject: "~{gl}", access: [BLEND]}
      - callExternal:
          subject: ~{gl}
          method: enable
          arguments: {subject: "~{gl}", access: [DEPTH_TEST]}
      # - callExternal:
      #     subject: ~{gl}
      #     method: enable
      #     arguments: {subject: "~{gl}", access: [CULL_FACE]}
      - callExternal:
          subject: ~{gl}
          method: depthFunc
          arguments: {subject: "~{gl}", access: [LEQUAL]}
      - callExternal:
          subject: ~{gl}
          method: blendFunc
          arguments:
          - {subject: "~{gl}", access: [SRC_ALPHA]}
          - {subject: "~{gl}", access: [ONE_MINUS_SRC_ALPHA]}
      # - callExternal:
      #     subject: ~{gl}
      #     method: cullFace
      #     arguments:
      #     - {subject: "~{gl}", access: [BACK]}
    - executeScript: loadImage
      parameters:
        src: turtle.png
        imageId: turtle
        vertexCount: ~{vertexCount}
        instanceCount: ~{instanceCount}
    - hooks: [hasImageId]
      pause: ~{not hasImageId("turtle")}
    - executeScript: refresh
      parameters:
        vertexCount: ~{vertexCount}
        instanceCount: ~{instanceCount}
      refresh:
        frameRate: 30
    tags: [main]
programs:
  - id: sample-motion
    vertex: ~reference=vertex.glsl      
    fragment: ~reference=fragment.glsl
